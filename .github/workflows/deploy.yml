name: Deploy Billing App to OCI

on:
  push:
    branches: [ "development" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/billing-app-ui/package-lock.json

      - name: Install UI Dependencies
        run: npm ci
        working-directory: src/billing-app-ui

      - name: Build UI
        run: npm run build -- --configuration production
        working-directory: src/billing-app-ui

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Publish API
        run: dotnet publish BillingApp.API/BillingApp.API.csproj -c Release -o publish
        working-directory: src

      - name: Copy Files to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USERNAME }}
          key: ${{ secrets.OCI_KEY }}
          source: "docker-compose.yml,src/billing-app-ui/Dockerfile,src/billing-app-ui/nginx.conf,src/billing-app-ui/dist/billing-app-ui/browser,src/BillingApp.API/Dockerfile,src/publish"
          target: "/home/ubuntu/billing-app"
          strip_components: 0

      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USERNAME }}
          key: ${{ secrets.OCI_KEY }}
          script: |
            # Install Docker if not exists (First run only)
            if ! command -v docker &> /dev/null; then
                sudo apt-get update
                sudo apt-get install -y ca-certificates curl gnupg
                sudo install -m 0755 -d /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
                sudo chmod a+r /etc/apt/keyrings/docker.gpg
                echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
                sudo apt-get update
                sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
                sudo usermod -aG docker $USER
            fi
            
            # Fix Oracle Cloud Ubuntu Firewall (iptables)
            sudo iptables -I INPUT -p tcp --dport 80 -j ACCEPT
            sudo iptables -I INPUT -p tcp --dport 443 -j ACCEPT
            sudo iptables -I INPUT -p tcp --dport 81 -j ACCEPT
            sudo netfilter-persistent save || echo "rules not saved"

            cd /home/ubuntu/billing-app
            
            # For consistent paths, we need to move the publish output where the Dockerfile expects it
            # docker-compose context for api is ./src
            mkdir -p src/BillingApp.API
            mv src/publish src/BillingApp.API/publish 2>/dev/null || true
            
            # docker-compose context for ui is ./src/billing-app-ui
            # (scp already put it in src/billing-app-ui/dist/billing-app-ui/browser)

            if [ ! -f .env ]; then
                cp .env.example .env
            fi

            # Pull latest images and restart
            sudo docker compose up -d --build
            
            # Diagnostics
            echo "--- Container Status ---"
            sudo docker ps
            echo "--- UI Logs ---"
            sudo docker logs billing-ui --tail 20
            echo "--- API Logs ---"
            sudo docker logs billing-api --tail 20
            sudo docker image prune -f
